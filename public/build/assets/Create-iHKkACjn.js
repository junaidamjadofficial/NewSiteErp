import{j as e}from"./ui-ZHFf5B17.js";import{r as h}from"./vendor-CcMVubkO.js";import{G as ne}from"./app-BBiA4mAE.js";import{a as ae,b as re,c as ie}from"./dialog-BLwxprq_.js";import{B as _}from"./button-DYC7yMVq.js";import{I as k}from"./input-DqOfVTcn.js";import{L as N}from"./label-DbqhUtKI.js";import{T as oe}from"./textarea-DxQ_BnuT.js";import{S as V,a as H,b as L,c as R,d as G}from"./select-BEhl2QER.js";import{C as F,a as B,b as E,c as M}from"./card-DHszHnbI.js";import{C as ce}from"./currency-input-BZrT8lhz.js";import{D as de}from"./date-picker-CVthJV3y.js";import{I as C}from"./input-error-DuIbBMgZ.js";import{f as q}from"./helpers-QYnGjXad.js";import{u as me}from"./useTranslation-CV4_gBnb.js";import{T as $}from"./trash-2-CIuynBL1.js";/* empty css            */import"./utils-DrcJ8Itn.js";import"./utils-B-dksMZM.js";import"./x-DVK_F_Gh.js";import"./createLucideIcon-Dov4NOxw.js";import"./index-BMyiKApA.js";import"./index-BdQq_4o_.js";import"./index-BYFX2qNQ.js";import"./index-BZAHB8Ku.js";import"./chevron-down-Zr-tNTku.js";import"./search-Chs14P_a.js";import"./check-DUlQPeVG.js";import"./react-datepicker-BHcKmBHW.js";import"./popover-fYI5j510.js";import"./calendar-DvmJ2XsD.js";function Le({customers:I,bankAccounts:T,onSuccess:O}){const{t:n}=me(),[D,S]=h.useState([]),[f,w]=h.useState([]),[r,g]=h.useState([]),[o,A]=h.useState([]),{data:l,setData:u,post:J,processing:P,errors:p}=ne({payment_date:new Date().toISOString().split("T")[0],customer_id:"",bank_account_id:"",reference_number:"",payment_amount:"",notes:"",allocations:[],credit_notes:[]});h.useEffect(()=>{u("allocations",r)},[r]),h.useEffect(()=>{u("credit_notes",o)},[o]);const K=async t=>{if(!t){S([]),w([]);return}try{const a=await(await fetch(route("account.customer-payments.outstanding-invoices",t))).json();S(a.invoices||a||[]),w(a.creditNotes||[])}catch(s){console.error("Failed to fetch outstanding invoices:",s),S([]),w([])}};h.useEffect(()=>{l.customer_id?K(l.customer_id):(S([]),w([])),g([]),A([]),u("payment_amount","")},[l.customer_id]);const Q=t=>{if(r.find(i=>i.invoice_id===t.id))return;const a={invoice_id:t.id,amount:t.balance_amount},c=[...r,a];g(c),j(c,o)},U=t=>{const s=r.filter(a=>a.invoice_id!==t);g(s),j(s,o)},W=(t,s)=>{const a=r.map(c=>c.invoice_id===t?{...c,amount:Number(s||0)}:c);g(a),j(a,o)},j=(t,s=o)=>{const a=t.reduce((m,d)=>m+Number(d.amount||0),0),c=s.reduce((m,d)=>m+Number(d.amount||0),0),i=a-c;u("payment_amount",Number(Math.max(0,i)).toFixed(2))},X=t=>{t.preventDefault(),J(route("account.customer-payments.store"),{onSuccess:()=>{O()}})},Y=t=>D.find(s=>s.id===t);return e.jsxs(ae,{className:"max-w-4xl",children:[e.jsx(re,{children:e.jsx(ie,{children:n("Create Customer Payment")})}),e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"payment_date",required:!0,children:n("Payment Date")}),e.jsx(de,{id:"payment_date",value:l.payment_date,onChange:t=>{const s=t instanceof Date?t.toISOString().split("T")[0]:t;u("payment_date",s)},placeholder:n("Select payment date"),required:!0}),e.jsx(C,{message:p.payment_date})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customer_id",required:!0,children:n("Customer")}),e.jsxs(V,{value:l.customer_id,onValueChange:t=>{u("customer_id",t)},children:[e.jsx(H,{children:e.jsx(L,{placeholder:n("Select Customer")})}),e.jsx(R,{children:I==null?void 0:I.map(t=>e.jsx(G,{value:t.id.toString(),children:t.name},t.id))})]}),e.jsx(C,{message:p.customer_id})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"bank_account_id",required:!0,children:n("Bank Account")}),e.jsxs(V,{value:l.bank_account_id,onValueChange:t=>u("bank_account_id",t),children:[e.jsx(H,{children:e.jsx(L,{placeholder:n("Select Bank Account")})}),e.jsx(R,{children:T==null?void 0:T.map(t=>e.jsxs(G,{value:t.id.toString(),children:[t.account_name," (",t.account_number,")"]},t.id))})]}),e.jsx(C,{message:p.bank_account_id})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"reference_number",children:n("Reference Number")}),e.jsx(k,{id:"reference_number",value:l.reference_number,onChange:t=>u("reference_number",t.target.value),placeholder:n("Check number, etc.")}),e.jsx(C,{message:p.reference_number})]})]}),l.customer_id&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(F,{children:[e.jsx(B,{children:e.jsx(E,{className:"text-sm",children:n("Outstanding Invoices")})}),e.jsx(M,{children:D.length>0?e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:D.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:t.invoice_number}),e.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["Balance: ",q(t.balance_amount)]})]}),e.jsx(_,{type:"button",size:"sm",onClick:()=>Q(t),disabled:r.some(s=>s.invoice_id===t.id),children:n("Add")})]},t.id))}):e.jsx("div",{className:"text-center py-4 text-gray-500",children:n("No outstanding invoices found for this customer")})})]}),e.jsxs(F,{children:[e.jsx(B,{children:e.jsx(E,{className:"text-sm",children:n("Available Credit Notes")})}),e.jsx(M,{children:f.length>0?e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:f.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:t.credit_note_number}),e.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["Balance: ",q(t.balance_amount)]})]}),e.jsx(_,{type:"button",size:"sm",variant:"outline",onClick:()=>{const s=r.reduce((v,b)=>v+b.amount,0),a=o.reduce((v,b)=>v+b.amount,0),c=s-a,i=Math.min(t.balance_amount,c),m={credit_note_id:t.id,amount:i>0?i:t.balance_amount},d=[...o,m];A(d),j(r,d)},disabled:o.some(s=>s.credit_note_id===t.id),children:n("Apply")})]},t.id))}):e.jsx("div",{className:"text-center py-4 text-gray-500",children:n("No credit notes available for this customer")})})]})]}),(r.length>0||o.length>0)&&e.jsxs(F,{children:[e.jsx(B,{children:e.jsx(E,{className:"text-sm",children:n("Payment Summary")})}),e.jsx(M,{children:e.jsxs("div",{className:"space-y-3",children:[r.map(t=>{const s=Y(t.invoice_id);return e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:s==null?void 0:s.invoice_number}),e.jsxs("div",{className:"text-sm text-gray-500",children:[n("Balance"),": ",q((s==null?void 0:s.balance_amount)||0)]})]}),e.jsx("div",{className:"w-32",children:e.jsx(k,{type:"number",step:"0.01",value:t.amount,onChange:a=>W(t.invoice_id,Number(a.target.value)||0),max:s==null?void 0:s.balance_amount})}),e.jsx(_,{type:"button",variant:"ghost",size:"sm",onClick:()=>U(t.invoice_id),children:e.jsx($,{className:"h-4 w-4 text-red-600"})})]},t.invoice_id)}),o.map((t,s)=>{var c;const a=f.find(i=>i.id===t.credit_note_id);return e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded bg-green-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-green-700",children:a==null?void 0:a.credit_note_number}),e.jsx("div",{className:"text-sm text-gray-500",children:n("Credit applied to payment")})]}),e.jsx("div",{className:"w-32",children:e.jsx(k,{type:"number",step:"0.01",value:t.amount,onChange:i=>{const m=Number(i.target.value);if(isNaN(m))return;const d=f.find(x=>x.id===t.credit_note_id),v=r.reduce((x,y)=>x+Number(y.amount||0),0),b=o.reduce((x,y,se)=>se!==s?x+Number(y.amount||0):x,0),Z=v-b,ee=Math.min((d==null?void 0:d.balance_amount)||0,Z),te=Math.max(0,Math.min(m,ee)),z=o.map((x,y)=>y===s?{...x,amount:te}:x);A(z),j(r,z)},max:Math.min(((c=f.find(i=>i.id===t.credit_note_id))==null?void 0:c.balance_amount)||0,r.reduce((i,m)=>i+m.amount,0)),className:"text-right"})}),e.jsx(_,{type:"button",variant:"ghost",size:"sm",onClick:()=>{const i=o.filter((m,d)=>d!==s);A(i),j(r,i)},children:e.jsx($,{className:"h-4 w-4 text-red-600"})})]},`credit-${s}`)})]})})]}),e.jsx("div",{children:e.jsx(ce,{label:n("Total Payment Amount"),value:l.payment_amount,onChange:t=>{u("payment_amount",t),parseFloat(t)!==r.reduce((s,a)=>s+a.amount,0)&&g([])},error:p.payment_amount,required:!0})}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"notes",children:n("Notes")}),e.jsx(oe,{id:"notes",value:l.notes,onChange:t=>u("notes",t.target.value),rows:3,placeholder:n("Enter notes")}),e.jsx(C,{message:p.notes})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(_,{type:"button",variant:"outline",onClick:O,children:n("Cancel")}),e.jsx(_,{type:"submit",disabled:P||!r.length&&!o.length,children:n(P?"Creating...":"Create")})]})]})]})}export{Le as default};
